<%- include('partials/header') %>

  <section class="calendar">
    <header class="calendar-head card">
      <h2 style="margin:0; display:flex; align-items:center; gap:0.6rem;">
        <a class="nav" href="/agenda?year=<%= prevYear %>&month=<%= prevMonth %>" aria-label="Mois précédent">&larr;</a>
        <span class="month-title" aria-live="polite">
          <%= monthName.charAt(0).toUpperCase() + monthName.slice(1) %>
            <%= year %>
        </span>
        <a class="nav" href="/agenda?year=<%= nextYear %>&month=<%= nextMonth %>" aria-label="Mois suivant">&rarr;</a>
      </h2>
      <p style="margin:0.5rem 0 0 0;"><a href="/">Retour à la liste</a> · <a href="/events/new">Nouveau devoir</a></p>
    </header>

    <table class="calendar-table">
      <thead>
        <tr>
          <th>Dim</th>
          <th>Lun</th>
          <th>Mar</th>
          <th>Mer</th>
          <th>Jeu</th>
          <th>Ven</th>
          <th>Sam</th>
        </tr>
      </thead>
      <tbody>
        <% weeks.forEach(function(week){ %>
          <tr>
            <% week.forEach(function(day){ %>
              <% if (!day) { %>
                <td class="empty"></td>
                <% } else { %>
                  <% const has=eventsByDay[day] && eventsByDay[day].length; %>
                    <td class="day <%= (todayDay === day ? 'today' : '') %> <%= (has ? 'has-event' : '') %>">
                      <div class="day-head">
                        <div class="day-num">
                          <%= day %>
                        </div>
                        <% if (has) { %>
                          <span class="badge">
                            <%= eventsByDay[day].length %>
                          </span>
                          <% } %>
                      </div>
                      <div class="day-events">
                        <!-- new wrapper to cap events height and allow scroll for overflow -->
                        <div class="events-list">
                          <% (eventsByDay[day] || []).slice(0,3).forEach(function(ev){ %>
                            <!-- n'affiche que le titre ; stocke l'objet évènement en JSON dans data-ev -->
                            <div class="event">
                              <button class="ev-title" type="button" data-ev='<%- JSON.stringify(ev) %>'
                                aria-haspopup="dialog">
                                <%= ev.title %>
                              </button>
                            </div>
                            <% }) %>
                        </div>
                        <% if (has && eventsByDay[day].length> 3) { %>
                          <div class="more">+<%= eventsByDay[day].length - 3 %> autres</div>
                          <% } %>
                      </div>
                    </td>
                    <% } %>
                      <% }); %>
          </tr>
          <% }); %>
      </tbody>
    </table>
  </section>

  <!-- Modal pour afficher les détails d'un événement -->
  <div id="event-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <button class="modal-close" aria-label="Fermer">&times;</button>
      <h3 id="modal-title"></h3>
      <div id="modal-meta" class="modal-meta"></div>
      <p id="modal-desc"></p>
      <div class="modal-actions">
        <a id="modal-open" class="button primary" href="#">Voir la page</a>
        <a id="modal-ical" class="button outline" href="#">Exporter iCal</a>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const modal = document.getElementById('event-modal');
      const titleEl = document.getElementById('modal-title');
      const metaEl = document.getElementById('modal-meta');
      const descEl = document.getElementById('modal-desc');
      const openEl = document.getElementById('modal-open');
      const icalEl = document.getElementById('modal-ical');
      const closeBtns = modal.querySelector('.modal-close');

      function openModal(evObj) {
        titleEl.textContent = evObj.title || '';
        const parts = [];
        if (evObj.subject) parts.push('Matière: ' + evObj.subject);
        if (evObj.class) parts.push('Classe: ' + evObj.class);
        if (evObj.creator && evObj.creator.username) parts.push('Créé par: ' + evObj.creator.username);
        if (evObj.due_date) {
          const d = new Date(evObj.due_date);
          parts.push('Date: ' + d.toISOString().slice(0, 10));
        }
        metaEl.innerHTML = parts.map(p => '<div class="meta-item">' + p + '</div>').join('');
        descEl.textContent = evObj.description || '';
        openEl.href = '/events/' + evObj.id;
        icalEl.href = '/events/' + evObj.id + '/ical';
        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      }

      function closeModal() {
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }

      document.querySelectorAll('.ev-title').forEach(function (btn) {
        btn.addEventListener('click', function (e) {
          const raw = btn.getAttribute('data-ev');
          try {
            const evObj = JSON.parse(raw);
            openModal(evObj);
          } catch (err) {
            // fallback : redirection vers page complète
            const parsed = btn.getAttribute('data-id');
            if (parsed) window.location = '/events/' + parsed;
          }
        });
      });

      // Fermeture
      closeBtns.addEventListener('click', closeModal);
      modal.addEventListener('click', function (e) {
        if (e.target === modal) closeModal();
      });
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
      });
    })();
  </script>

  <%- include('partials/footer') %>