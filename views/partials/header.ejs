<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agenda</title>
  <link rel="stylesheet" href="/style.css">
</head>

<body>
  <header>
    <div class="header-left">
      <h1><a href="/">Agenda</a></h1>
      <div class="kicker">Planifiez, suivez et partagez vos devoirs</div>
    </div>
    <div class="header-right">
      <nav>
        <a class="button outline" href="/agenda" aria-label="Voir calendrier">Calendrier</a>

        <% if (locals.user) { %>
          <a class="button outline" href="/notifications" aria-label="Notifications" style="position:relative;">
            ðŸ”” Notifications
            <span id="notif-badge"
              style="display:none; position:absolute; top:-5px; right:-5px; background:red; color:white; border-radius:50%; width:20px; height:20px; font-size:12px; text-align:center; line-height:20px;"></span>
          </a>
          <% } %>
            <% if (locals.user && locals.user.isAdmin) { %>
              <a class="button outline" href="/admin/users">Admin</a>
              <% } %>
                <% if (locals.user) { %>
                  <span style="margin-right: 1rem;">Salut, <strong>
                      <%= locals.user.username %>
                    </strong></span>
                  <a class="button muted" href="/logout" aria-label="Se dÃ©connecter">DÃ©connexion</a>
                  <% } else { %>
                    <a class="button muted" href="/login" aria-label="Se connecter">Connexion</a>
                    <% } %>
      </nav>
    </div>
  </header>
  <main>

    <% if (locals.user) { %>
      <script>
        // Fetch unread notification count
        async function updateNotificationBadge() {
          try {
            const response = await fetch('/notifications/unread-count');
            const data = await response.json();
            const badge = document.getElementById('notif-badge');
            if (data.count > 0) {
              badge.textContent = data.count > 9 ? '9+' : data.count;
              badge.style.display = 'block';
            } else {
              badge.style.display = 'none';
            }
          } catch (error) {
            console.error('Error fetching notification count:', error);
          }
        }

        // Update badge on page load
        updateNotificationBadge();

        // Update badge every 30 seconds
        setInterval(updateNotificationBadge, 30000);
      </script>
      <% } %>